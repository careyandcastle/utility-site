<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Server 2025 æˆæ¬Šè²»ç”¨çµ‚æ¥µè©¦ç®—å·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; color: #333; line-height: 1.6; }
        .header { text-align: center; margin-bottom: 20px; color: #a4373a; }
        .container { display: flex; gap: 20px; max-width: 1200px; margin: auto; flex-wrap: wrap; }
        .panel { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); flex: 1; min-width: 450px; }
        .full-width { flex: 100%; min-width: 100%; margin-top: 10px; }
        
        /* è¡¨å–®å€åŸŸæ¨£å¼ */
        .form-group { margin-bottom: 20px; background: #fff8f0; padding: 15px; border-left: 4px solid #f25022; border-radius: 4px; }
        label { font-weight: bold; display: block; margin-bottom: 8px; }
        input[type="number"] { width: 100px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        .hint { font-size: 13px; color: #666; margin-top: 5px; display: block; }
        
        /* å·¢ç‹€ä¸»æ©Ÿèˆ‡ VM å€å¡Šæ¨£å¼ */
        #hosts-container { margin-top: 20px; }
        .host-block { border: 1px solid #e1dfdd; padding: 15px; margin-bottom: 20px; border-radius: 6px; background: #faf9f8; }
        .host-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-weight: bold; color: #333; border-bottom: 2px solid #ccc; padding-bottom: 8px;}
        .host-inputs { display: flex; gap: 15px; align-items: center; margin-bottom: 15px; background: #eee; padding: 10px; border-radius: 4px;}
        
        .vms-container { padding-left: 20px; border-left: 3px solid #a4373a; }
        .vm-block { border: 1px solid #ddd; padding: 12px; margin-bottom: 10px; border-radius: 4px; background: #fff; display: flex; justify-content: space-between; align-items: center;}
        
        /* æŒ‰éˆ•æ¨£å¼ */
        button { background: #a4373a; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; transition: background 0.2s; }
        button:hover { background: #8a2e31; }
        .btn-add-vm { background: #107c10; font-size: 13px; padding: 6px 12px; margin-top: 5px; }
        .btn-add-vm:hover { background: #0b5a0b; }
        .btn-remove { background: #d13438; padding: 6px 12px; }
        .btn-remove:hover { background: #a80000; }
        
        /* çµæœå€åŸŸæ¨£å¼ */
        .result-box { padding: 15px; margin-bottom: 15px; border-radius: 6px; border: 1px solid #ddd; }
        .cost-title { font-size: 14px; color: #333; margin-bottom: 5px; font-weight: bold; }
        .cost-value { font-size: 22px; font-weight: bold; }
        .winner { background-color: #e8f5e9; border-color: #4caf50; border-width: 2px;}
        .winner .cost-value { color: #2e7d32; }
        .chart-container { position: relative; height: 300px; width: 100%; margin-top: 30px; }

        /* å…¬å¼å€åŸŸæ¨£å¼ */
        .formula-box { background: #f3f2f1; padding: 20px; border-radius: 6px; border-left: 4px solid #a4373a; font-family: 'Consolas', 'Courier New', Courier, monospace; font-size: 14px; }
        .formula-item { margin-bottom: 15px; }
        .formula-item strong { font-family: 'Segoe UI', sans-serif;}
        .host-formula { margin-left: 15px; border-left: 2px solid #ccc; padding-left: 15px; margin-top: 10px; }
        .vm-formula { margin-left: 15px; color: #555; font-size: 13px; }
        .highlight-calc { background: #e1dfdd; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="header">
        <h2>SQL Server 2025 æˆæ¬Šè²»ç”¨çµ‚æ¥µè©¦ç®—å·¥å…· (åŒ…å«å¯¦é«”ä¸»æ©Ÿè¨ˆç®—)</h2>
    </div>

    <div class="container">
        <div class="panel">
            <h3>ç’°å¢ƒåƒæ•¸è¨­å®š</h3>
            <div class="form-group">
                <label for="total-users">å…¨ç’°å¢ƒä¸é‡è¤‡å­˜å–äººæ•¸ / è¨­å‚™æ•¸ (U<sub>total</sub>)</label>
                <input type="number" id="total-users" value="3000" min="0" oninput="calculateCosts()">
                <span class="hint">âš ï¸ æ³¨æ„ï¼šè‹¥èµ°æ ¸å¿ƒæˆæ¬Šæ¨¡å¼ (æ–¹æ¡ˆ B æˆ– C)ï¼Œæ­¤äººæ•¸å°‡ç„¡é—œç·Šè¦ (å… CAL)ã€‚</span>
            </div>
            
            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
            
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0;">æ©Ÿæˆ¿ä¸»æ©Ÿèˆ‡ VM é…ç½®</h3>
                <button onclick="addHost()">+ æ–°å¢å¯¦é«”ä¸»æ©Ÿ</button>
            </div>
            
            <div id="hosts-container">
                </div>
        </div>

        <div class="panel">
            <h3>è©¦ç®—çµæœåˆ†æ (è‡ªå‹•æ¨™è¨˜æœ€åˆ’ç®—)</h3>
            
            <div id="result-sc" class="result-box">
                <div class="cost-title" style="color: #0078d4;">æ–¹æ¡ˆ Aï¼šServer + CAL æ¨¡å¼ (ä¾äººé ­)</div>
                <div class="cost-value" id="cost-sc-val">NT$ 0</div>
                <div style="font-size: 12px; color: #666;">é©åˆï¼šVM æ•¸é‡æ¥µå°‘ï¼Œä¸”å­˜å–äººæ•¸ä½æ–¼ 30 äººçš„ç’°å¢ƒã€‚</div>
            </div>
            
            <div id="result-std-core" class="result-box">
                <div class="cost-title" style="color: #107c10;">æ–¹æ¡ˆ Bï¼šStandard æ ¸å¿ƒæ¨¡å¼ (åªçœ‹ VM)</div>
                <div class="cost-value" id="cost-std-core-val">NT$ 0</div>
                <div style="font-size: 12px; color: #666;">é©åˆï¼šå­˜å–äººæ•¸å¤šï¼Œä½†ä¸»æ©Ÿä¸Šçš„ SQL VM æ•¸é‡ä¸å¤šã€‚å…è²· CALã€‚</div>
            </div>

            <div id="result-ent-core" class="result-box">
                <div class="cost-title" style="color: #742774;">æ–¹æ¡ˆ Cï¼šEnterprise æ ¸å¿ƒæ¨¡å¼ (è²·æ–·å¯¦é«”ä¸»æ©Ÿ)</div>
                <div class="cost-value" id="cost-ent-core-val">NT$ 0</div>
                <div style="font-size: 12px; color: #666;">é©åˆï¼šé«˜å¯†åº¦è™›æ“¬åŒ–ã€‚è²·æ»¿å¯¦é«”æ ¸å¿ƒå³å¯é–‹ã€Œç„¡é™å°ã€SQL VMã€‚å…è²· CALã€‚</div>
            </div>

            <div class="chart-container">
                <canvas id="costChart"></canvas>
            </div>
        </div>

        <div class="panel full-width">
            <h3>ğŸ§® è²»ç”¨è¨ˆç®—å…¬å¼èˆ‡æ˜ç´° (å‹•æ…‹å¸¶å…¥)</h3>
            <div class="formula-box" id="dynamic-formula-box">
                </div>
        </div>
    </div>

    <script>
        // å®šåƒ¹å¸¸æ•¸ (æ–°å°å¹£ CSP åƒè€ƒå ±åƒ¹)
        const P_SERVER = 35700;       // SQL Standard ä¸»ç¨‹å¼
        const P_CAL = 8303;           // SQL User CAL
        const P_STD_CORE = 142479;    // SQL Standard 2æ ¸å¿ƒåŒ… (VMç”¨)
        const P_ENT_CORE = 546235;    // SQL Enterprise 2æ ¸å¿ƒåŒ… (ä¸»æ©Ÿç”¨)

        let hostCount = 0;
        let chartInstance = null;

        function initChart() {
            const ctx = document.getElementById('costChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['æ–¹æ¡ˆ A (Server+CAL)', 'æ–¹æ¡ˆ B (çœ‹VM-æ¨™æº–ç‰ˆ)', 'æ–¹æ¡ˆ C (çœ‹ä¸»æ©Ÿ-ä¼æ¥­ç‰ˆ)'],
                    datasets: [{
                        label: 'é ä¼°ç¸½è²»ç”¨ (NT$)',
                        data: [0, 0, 0],
                        backgroundColor: ['#0078d4', '#107c10', '#742774'],
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { callback: function(value) { return 'NT$ ' + value.toLocaleString(); } } } },
                    plugins: { tooltip: { callbacks: { label: function(context) { return 'NT$ ' + context.raw.toLocaleString(); } } } }
                }
            });
        }

        function addHost() {
            hostCount++;
            const hostId = `host-${Date.now()}`;
            const hostHtml = `
                <div class="host-block" id="${hostId}" data-index="${hostCount}">
                    <div class="host-header">
                        <span>å¯¦é«”ä¸»æ©Ÿ #${hostCount}</span>
                        <button class="btn-remove" onclick="removeElement('${hostId}')">åˆªé™¤ä¸»æ©Ÿ</button>
                    </div>
                    <div class="host-inputs">
                        <label style="margin:0;">è©²ä¸»æ©Ÿå¯¦é«”ç¸½æ ¸å¿ƒæ•¸ (Physical Cores)ï¼š</label>
                        <input type="number" class="host-core-count" value="16" min="4" oninput="calculateCosts()">
                        <span style="font-size:12px; color:#666;">(æœ€å°‘éœ€4æ ¸)</span>
                    </div>
                    <div class="vms-container" id="vms-${hostId}"></div>
                    <button class="btn-add-vm" onclick="addVM('${hostId}')">+ æ–°å¢æ­¤ä¸»æ©Ÿä¸Šçš„ SQL VM</button>
                </div>
            `;
            document.getElementById('hosts-container').insertAdjacentHTML('beforeend', hostHtml);
            addVM(hostId); // é è¨­çµ¦ä¸€å° VM
        }

        function addVM(hostId) {
            const vmId = `vm-${Date.now()}`;
            const vmHtml = `
                <div class="vm-block" id="${vmId}">
                    <span style="font-weight:bold; color:#a4373a;">SQL VM</span>
                    <div>
                        <label style="display:inline; margin:0;">é…ç½®è™›æ“¬æ ¸å¿ƒ (vCPU)ï¼š</label>
                        <input type="number" class="vm-core-count" value="4" min="1" oninput="calculateCosts()">
                        <button class="btn-remove" style="margin-left:10px; padding:4px 8px;" onclick="removeElement('${vmId}')">åˆªé™¤</button>
                    </div>
                </div>
            `;
            document.getElementById(`vms-${hostId}`).insertAdjacentHTML('beforeend', vmHtml);
            calculateCosts();
        }

        function removeElement(elementId) {
            document.getElementById(elementId).remove();
            calculateCosts();
        }

        function calculateCosts() {
            const totalUsers = parseInt(document.getElementById('total-users').value) || 0;
            const hosts = document.querySelectorAll('.host-block');
            
            let totalVms = document.querySelectorAll('.vm-block').length;
            
            // æ–¹æ¡ˆ A: Server + CAL
            let costServer = totalVms * P_SERVER;
            let costCal = totalUsers * P_CAL;
            let totalScCost = costServer + costCal;

            // æ–¹æ¡ˆ B & C è¨ˆç®—
            let totalStdCoreCost = 0; // åªçœ‹ VM (Standard)
            let totalEntCoreCost = 0; // åªçœ‹ä¸»æ©Ÿ (Enterprise)
            
            let formulaHtml = ``;

            // ç”Ÿæˆæ–¹æ¡ˆ A å…¬å¼
            formulaHtml += `
                <div class="formula-item">
                    <strong style="color: #0078d4;">ğŸ“Œ æ–¹æ¡ˆ Aï¼šServer + CAL æ¨¡å¼</strong><br>
                    <div>â€¢ ä¼ºæœå™¨ï¼š${totalVms} å° VM Ã— NT$ ${P_SERVER.toLocaleString()} = NT$ ${costServer.toLocaleString()}</div>
                    <div>â€¢ CALæˆæ¬Šï¼š${totalUsers} äºº Ã— NT$ ${P_CAL.toLocaleString()} = NT$ ${costCal.toLocaleString()}</div>
                    <div>â–¶ ç¸½è¨ˆ = <span class="highlight-calc" style="color: #0078d4;">NT$ ${totalScCost.toLocaleString()}</span></div>
                </div>
                <hr style="border: 0; border-top: 1px dashed #ccc; margin: 15px 0;">
                <div class="formula-item">
                    <strong>ğŸ“Œ æ–¹æ¡ˆ B (çœ‹VM) èˆ‡ æ–¹æ¡ˆ C (çœ‹ä¸»æ©Ÿ) æ ¸å¿ƒæˆæ¬Šæ¯”è¼ƒ</strong>
            `;

            let hIndex = 1;
            hosts.forEach(host => {
                const hostCores = parseInt(host.querySelector('.host-core-count').value) || 0;
                const vms = host.querySelectorAll('.vm-block');
                
                // è¨ˆç®—æ­¤ä¸»æ©Ÿçš„ Enterprise æˆæœ¬ (å¯¦é«”æ ¸å¿ƒè‡³å°‘ç®—4æ ¸=2åŒ…)
                let requiredHostPacks = Math.max(2, Math.ceil(hostCores / 2));
                let hostEntCost = requiredHostPacks * P_ENT_CORE;
                totalEntCoreCost += hostEntCost;

                formulaHtml += `
                    <div class="host-formula">
                        <strong style="color:#333;">å¯¦é«”ä¸»æ©Ÿ #${hIndex}</strong>
                        <div style="color: #742774;">[æ–¹æ¡ˆC] è²·æ–·ä¸»æ©Ÿå¯¦é«” ${hostCores} æ ¸ â” éœ€ ${requiredHostPacks} å¥—ä¼æ¥­ç‰ˆ = <strong>NT$ ${hostEntCost.toLocaleString()}</strong> (ç„¡é™VM)</div>
                `;

                // è¨ˆç®—æ­¤ä¸»æ©Ÿå…§æ‰€æœ‰ VM çš„ Standard æˆæœ¬
                let hostVmTotalStdCost = 0;
                let vIndex = 1;
                vms.forEach(vm => {
                    const vmCores = parseInt(vm.querySelector('.vm-core-count').value) || 0;
                    let requiredVmPacks = Math.max(2, Math.ceil(vmCores / 2));
                    let vmStdCost = requiredVmPacks * P_STD_CORE;
                    hostVmTotalStdCost += vmStdCost;
                    
                    formulaHtml += `
                        <div class="vm-formula">
                            â†³ VM #${vIndex}: é…ç½® ${vmCores} vCPU â” éœ€ ${requiredVmPacks} å¥—æ¨™æº–ç‰ˆ = NT$ ${vmStdCost.toLocaleString()}
                        </div>
                    `;
                    vIndex++;
                });
                
                totalStdCoreCost += hostVmTotalStdCost;

                formulaHtml += `
                        <div style="color: #107c10; margin-top:5px;">[æ–¹æ¡ˆB] ä¸»æ©Ÿå…§æ‰€æœ‰ VM ç–ŠåŠ  = <strong>NT$ ${hostVmTotalStdCost.toLocaleString()}</strong></div>
                    </div>
                `;
                hIndex++;
            });

            formulaHtml += `
                </div>
                <hr style="border: 0; border-top: 1px dashed #ccc; margin: 15px 0;">
                <div class="formula-item">
                    <strong style="color: #107c10;">â–¶ æ–¹æ¡ˆ B ç¸½è¨ˆ (å„VMåŠ ç¸½) = <span class="highlight-calc">NT$ ${totalStdCoreCost.toLocaleString()}</span></strong><br>
                    <strong style="color: #742774;">â–¶ æ–¹æ¡ˆ C ç¸½è¨ˆ (å„ä¸»æ©ŸåŠ ç¸½) = <span class="highlight-calc">NT$ ${totalEntCoreCost.toLocaleString()}</span></strong>
                </div>
            `;

            document.getElementById('dynamic-formula-box').innerHTML = formulaHtml;

            // æ›´æ–°ç•«é¢ç¸½è¨ˆ
            document.getElementById('cost-sc-val').innerText = `NT$ ${totalScCost.toLocaleString()}`;
            document.getElementById('cost-std-core-val').innerText = `NT$ ${totalStdCoreCost.toLocaleString()}`;
            document.getElementById('cost-ent-core-val').innerText = `NT$ ${totalEntCoreCost.toLocaleString()}`;

            // æ¨™è¨˜æœ€åˆ’ç®—æ–¹æ¡ˆ
            const resultBoxA = document.getElementById('result-sc');
            const resultBoxB = document.getElementById('result-std-core');
            const resultBoxC = document.getElementById('result-ent-core');
            
            resultBoxA.classList.remove('winner');
            resultBoxB.classList.remove('winner');
            resultBoxC.classList.remove('winner');
            
            if (totalVms > 0 || totalUsers > 0 || hosts.length > 0) {
                let minCost = Math.min(totalScCost, totalStdCoreCost, totalEntCoreCost);
                if (minCost === totalScCost) resultBoxA.classList.add('winner');
                else if (minCost === totalStdCoreCost) resultBoxB.classList.add('winner');
                else if (minCost === totalEntCoreCost) resultBoxC.classList.add('winner');
            }

            if (chartInstance) {
                chartInstance.data.datasets[0].data = [totalScCost, totalStdCoreCost, totalEntCoreCost];
                chartInstance.update();
            }
        }

        window.onload = () => {
            initChart();
            addHost(); 
        };
    </script>
</body>
</html>